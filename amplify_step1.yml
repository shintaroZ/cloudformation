AWSTemplateFormatVersion: 2010-09-09
Description: Step 1, Pre-requirements (in Production Account)
# ------------------------------------------------------------#
# Input Parameters
# ------------------------------------------------------------#
Parameters:
# 開発環境のアカウント
  RepositoryAccountId:
    Description: "Repository Account ID"
    MaxLength: 12
    MinLength: 12
    Type: String
    Default : "968506721144"
    
  RepositoryAccountARN:
    Description: "Repository Account ARN"
    Type: String
    Default : "arn:aws:iam::968506721144:user/St-Dev-Otoi"
    
  UserName:
    Description: "login user name"
    Type: String
    Default : "hogeAdmin"

Resources:
# ------------------------------------------------------------#
# PipelineRole create
# ------------------------------------------------------------#
  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - codepipeline.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: Pipeline
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 
                  - sts:AssumeRole
                Resource:
#                  - !Sub arn:aws:iam::${RepositoryAccountId}:role/* # Cross Account Access
                  - !Sub ${RepositoryAccountARN}
              - Effect: Allow
                Action: 
                  - iam:PassRole
                Resource:
                  - "*"
                Condition: 
                  StringEqualsIfExists: 
                    iam:PassedToService: 
                      - cloudformation.amazonaws.com
                      - elasticbeanstalk.amazonaws.com
                      - ec2.amazonaws.com
                      - ecs-tasks.amazonaws.com
              - Effect: Allow
                Action: 
                  - codecommit:CancelUploadArchive
                  - codecommit:GetBranch
                  - codecommit:GetCommit
                  - codecommit:GetUploadArchiveStatus
                  - codecommit:UploadArchive
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - codedeploy:CreateDeployment
                  - codedeploy:GetApplication
                  - codedeploy:GetApplicationRevision
                  - codedeploy:GetDeployment
                  - codedeploy:GetDeploymentConfig
                  - codedeploy:RegisterApplicationRevision
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - elasticbeanstalk:*
                  - ec2:*
                  - elasticloadbalancing:*
                  - autoscaling:*
                  - cloudwatch:*
                  - s3:*
                  - sns:*
                  - cloudformation:*
                  - rds:*
                  - sqs:*
                  - ecs:*
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - lambda:InvokeFunction
                  - lambda:ListFunctions
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - opsworks:CreateDeployment
                  - opsworks:DescribeApps
                  - opsworks:DescribeCommands
                  - opsworks:DescribeDeployments
                  - opsworks:DescribeInstances
                  - opsworks:DescribeStacks
                  - opsworks:UpdateApp
                  - opsworks:UpdateStack
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - cloudformation:CreateStack
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                  - cloudformation:UpdateStack
                  - cloudformation:CreateChangeSet
                  - cloudformation:DeleteChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:SetStackPolicy
                  - cloudformation:ValidateTemplate
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - codebuild:BatchGetBuilds
                  - codebuild:StartBuild
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - devicefarm:ListProjects
                  - devicefarm:ListDevicePools
                  - devicefarm:GetRun
                  - devicefarm:GetUpload
                  - devicefarm:CreateUpload
                  - devicefarm:ScheduleRun
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - servicecatalog:ListProvisioningArtifacts
                  - servicecatalog:CreateProvisioningArtifact
                  - servicecatalog:DescribeProvisioningArtifact
                  - servicecatalog:DeleteProvisioningArtifact
                  - servicecatalog:UpdateProduct
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - cloudformation:ValidateTemplate
                Resource:
                  - "*"
              - Effect: Allow
                Action: 
                  - ecr:DescribeImages
                Resource:
                  - "*"

# ------------------------------------------------------------#
# DeployRole create
# ------------------------------------------------------------#
  DeployRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - codedeploy.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole

# ------------------------------------------------------------#
# s3 bucket create
# ------------------------------------------------------------#
  S3Bucket:
    # DeletionPolicy: Retain
    Description: Creating Amazon S3 bucket for AWS CodePipeline artifacts
    Properties:
      BucketName: !Join
      - "-"
      - - artifacts
        - !Ref AWS::Region
        - !Ref AWS::AccountId
        - "pipeline"
      VersioningConfiguration:
        Status: Enabled
    Type: AWS::S3::Bucket

# ------------------------------------------------------------#
# s3 BucketPolicy create
# ------------------------------------------------------------#
  S3ArtifactBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Description: Setting Amazon S3 bucket policy for AWS CodePipeline access
    Properties:
      Bucket: !Ref S3Bucket
      PolicyDocument:
        Statement:
        - Action:
          - s3:PutObject
          Effect: Deny
          Principal: "*"
          Resource:
          - !Sub arn:aws:s3:::${S3Bucket}/*
          Condition: 
            StringNotEquals: 
              s3:x-amz-server-side-encryption: aws:kms
        - Action:
          - s3:*
          Effect: Deny
          Principal: "*"
          Resource:
          - !Sub arn:aws:s3:::${S3Bucket}/*
          Condition: 
            Bool: 
              aws:SecureTransport: false
        - Action:
          - s3:Get*
          - s3:Put*
          Effect: Allow
          Principal:
            AWS:
#            - !Sub arn:aws:iam::${RepositoryAccountId}:root
            - !Sub ${RepositoryAccountARN}
          Resource:
          - !Sub arn:aws:s3:::${S3Bucket}/*
        - Action:
          - s3:ListBucket
          Effect: Allow
          Principal:
            AWS:
#            - !Sub arn:aws:iam::${RepositoryAccountId}:root
            - !Sub ${RepositoryAccountARN}
          Resource:
          - !Sub arn:aws:s3:::${S3Bucket}
        Version: 2012-10-17
        
# ------------------------------------------------------------#
# kms create
# ------------------------------------------------------------#
  Key:
    Type: AWS::KMS::Key
    Properties:
      Description: An example symmetric CMK
      KeyPolicy:
        Version: 2012-10-17
        Id: key-default-1
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS:
#            - !Sub arn:aws:iam::${AWS::AccountId}:root
            - !Sub ${RepositoryAccountARN}
          Action: kms:*
          Resource: "*"
        - Sid: Allow administration of the key
          Effect: Allow
          Principal:
            AWS:
            - !Sub arn:aws:iam::${AWS::AccountId}:user/${UserName}
          Action:
          - kms:Create*
          - kms:Describe*
          - kms:Enable*
          - kms:List*
          - kms:Put*
          - kms:Update*
          - kms:Revoke*
          - kms:Disable*
          - kms:Get*
          - kms:Delete*
          - kms:ScheduleKeyDeletion
          - kms:CancelKeyDeletion
          Resource: "*"
        - Sid: Allow use of the key
          Effect: Allow
          Principal:
            AWS:
#            - !Sub arn:aws:iam::${RepositoryAccountId}:root
            - !Sub ${RepositoryAccountARN}
            - !GetAtt PipelineRole.Arn
            - !GetAtt DeployRole.Arn
          Action:
          - kms:DescribeKey
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey
          - kms:GenerateDataKeyWithoutPlaintext
          Resource: "*"
        - Sid: Allow attachment of persistent resources
          Effect: Allow
          Principal:
            AWS:
#            - !Sub arn:aws:iam::${RepositoryAccountId}:root
            - !Sub ${RepositoryAccountARN}
            - !GetAtt PipelineRole.Arn
            - !GetAtt DeployRole.Arn
          Action:
          - kms:CreateGrant
          - kms:ListGrants
          - kms:RevokeGrant
          Resource: "*"
          Condition:
            Bool: 
              kms:GrantIsForAWSResource: true
# ------------------------------------------------------------#
# kms Alias create
# ------------------------------------------------------------#
  Alias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: alias/CodePipelineArtifact
      TargetKeyId:
        Ref: Key
        
        
# ------------------------------------------------------------#
# Output Parameters
# ------------------------------------------------------------#
Outputs:
      
  ArtifactBucketName:
    Value: !Ref S3Bucket
    Export:
      Name: "ArtifactBucketName"
      
  CmkArn:
    Value: !GetAtt Key.Arn
    Export:
      Name: "CmkArn"
      
  CodePipelineRoleArn:
    Value: !GetAtt PipelineRole.Arn
    Export:
      Name: "CodePipelineRoleArn"

  CodeDeployRoleArn:
    Value: !GetAtt DeployRole.Arn
    Export:
      Name: "CodeDeployRoleArn"
